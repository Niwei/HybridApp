<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>Hello MUI</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../css/mui.min.css">
		<style>
			html,
			body {
				background-color: #efeff4;
			}
			.title {
				padding: 20px 15px 10px;
				color: #6d6d72;
				font-size: 15px;
				background-color: #fff;
			}
			.tab-list{position: relative;
  display: table;
  width: 100%;
  overflow: hidden;
  font-size: 15px;
  font-weight: 400;
  table-layout: fixed;
  background-color: transparent;
  border: 1px solid #007aff;
  border-radius: 3px;
  -webkit-touch-callout: none;}
			.tab-list a{display: table-cell;
			  overflow: hidden;
			  line-height: 38px;
			  color: #007aff;
			  text-align: center;
			  text-overflow: ellipsis;
			  white-space: nowrap;
			  border-color: #007aff;
			  border-left: 1px solid #007aff;
			  -webkit-transition: background-color .1s linear;
			  transition: background-color .1s linear;}
		</style>
	</head>

	<body>
		<div class="tab-list" id="tab_list">
			<a href="#" data-type="0">所有</a> 
			<a href="#" data-type="1">待抢单</a>
			<a href="#" data-type="2">待运送</a>
			<a href="#" data-type="3">运送中</a>
			<a href="#" data-type="4">已送到</a>
			<a href="#" data-type="6">取消</a>
		</div>
		<div id="pullrefresh" class="mui-content mui-scroll-wrapper">
			<div class="mui-scroll">
				<div class="title">
					这是webview模式选项卡中的第2个子页面，该页面展示一个支持下拉刷新、上拉加载的消息列表
				</div>
				
				<ul class="mui-table-view mui-table-view-chevron" id="order_list">
					
				</ul>
			</div>
		</div>
		<script src="../js/mui.min.js"></script>
		<script type="text/javascript" src="../js/config.js" ></script>
		<script type="text/javascript" src="../js/doT.min.js" ></script>
		<script type="text/javascript" src="../js/global.js" ></script>
		<script type="text/javascript" src="../js/zepto.min.js" ></script>
		<script>
			mui.init({
				swipeBack: false,
				pullRefresh: {
					container: '#pullrefresh',
					down: {
						callback: pulldownRefresh
					},
					up: {
						contentrefresh: '正在加载...',
						callback: pullupRefresh
					}
				}
			});
			
			var d={
				status:0,
				start:""
			}//status 状态 start 最后取到的订单ID
			var tab_a = document.querySelector("#tab_list a"),
				table = document.querySelector('.mui-table-view'),
				tpl_commont="",tpl = "",
				ajax_status=true,
				detailPage="",order_id="",first_load=true;
			mui.ready(function(){
				ajax_list();
				
			})
			mui("#tab_list").on("tap","a",function(e){
				d.status=this.dataset.type;
				d.start="";
				if(ajax_status){
					ajax_list("down");
				}
			})
			mui("#order_list").on("tap","li",function(e){
			  order_id = this.dataset.id;
			  //获得详情页面
			  //var embed = plus.webview.getWebviewById('place_order.html'); //a为 a页面的id值
					
					
			  
			  //detailPage = plus.webview.getWebviewById('order_detail.html');
			  //detailPage.evalJS("getdata()");
			  //触发详情页面的newsId事件
//			  mui.fire(detailPage,'orderId',{
//			    id:id
//			  });
			//打开详情页面          
			  mui.openWindow({
			     id:'order_detail.html',
			     url:"../app/order/order_detail.html",
			      extras:{
				        order_id:order_id
				    }
			  });
			})
         
              
			/**
			 * 下拉刷新具体业务实现
			 */
			function pulldownRefresh() {
				d.start="";
				ajax_list("down");
				
			}
			
			/**
			 * 上拉加载具体业务实现
			 */
			function pullupRefresh() {
				ajax_list("up");
				
//				setTimeout(function() {
//					mui('#pullrefresh').pullRefresh().endPullupToRefresh((++count > 2)); //参数为true代表没有更多数据了。
//					var table = document.body.querySelector('.mui-table-view');
//					var cells = document.body.querySelectorAll('.mui-table-view-cell');
//					for (var i = cells.length, len = i + 20; i < len; i++) {
//						var li = document.createElement('li');
//						li.className = 'mui-table-view-cell';
//						li.innerHTML = '<a class="mui-navigate-right">Item ' + (i + 1) + '</a>';
//						table.appendChild(li);

//					}
//				}, 1000);
			}
			function ajax_list(tpye){
				ajax_status=false;
				mui.ajax(config.url.host+"/order_list",{
				data:{
					user_id:config.com.userId,
					status:d.status,
					start:d.start
				},
				dataType:'json',//服务器返回json格式数据
				type:'POST',//HTTP请求类型
				timeout:10000,//超时时间设置为10秒；
				success:function(info){
					var args=info.data;
					if(args.length!=0){
						d.start=args[args.length-1].id
					}
						tel(tpye,args);
					ajax_status=true;
					
			        
				},
				error:function(xhr,type,errorThrown){
					//异常处理；
					console.log(type);
					
				}
			});
				
			}
			function tel(tpye,info){
					if(!tpl_commont) {
		                    // 获取模板
		                    GLOBAL.setTpl('../templates/tpl_order_list.html', 'tpl_order_list', function(tmp){
	                            tpl_commont=tmp;
	          					tpl=doT.template(tmp||tpl_commont);
	          					if(tpye=="down"){
	          						$(table).html(tpl(info));
	          						mui('#pullrefresh').pullRefresh().endPulldownToRefresh(); //refresh completed
	          						if(info.length==0){
	          							first_load?first_load=false:mui.toast('没有更多数据了');
	          						}
	          					}else{
	          						$(table).append(tpl(info));
	          						mui('#pullrefresh').pullRefresh().endPullupToRefresh();
	          						if(info.length==0){
	          							first_load?first_load=false:mui.toast('没有更多数据了');
	          						}
	          					}
	            						            				
	                    	});
		                }else{
		                	if(tpye=="down"){
	          						tpl = doT.template(tpl_commont);
		                		    $(table).html(tpl(info));
		                		    mui('#pullrefresh').pullRefresh().endPulldownToRefresh(); //refresh completed
		                		    if(info.length==0){
	          							first_load?first_load=false:mui.toast('没有更多数据了');
	          						}
	          					}else{
	          						tpl = doT.template(tpl_commont);
		                		    $(table).append(tpl(info));
		                		    mui('#pullrefresh').pullRefresh().endPullupToRefresh();
		                		    if(info.length==0){
	          							first_load?first_load=false:mui.toast('没有更多数据了');
	          						}
	          					}
		                		
			    
				}
			
			}
			
		</script>
	</body>
</html>